name: Codex Apply Mission to PR

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - ".agent/missions/**/*.md"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-mission-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  codex-apply:
    runs-on: ubuntu-latest

    # codex-bot이 만든 커밋 때문에 다시 synchronize가 떠도 job 자체를 막음 (루프 방지)
    if: github.actor != 'codex-bot'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: List changed mission markdown files
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^\.agent/missions/.*\.md' || true)

          echo "changed_missions<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Stop if no mission change
        if: steps.diff.outputs.changed_missions == ''
        run: |
          echo "No mission md changes detected. Skipping Codex."
          exit 0

      - name: Run Codex agent to apply mission
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CHANGED_MISSIONS: ${{ steps.diff.outputs.changed_missions }}
        run: |
          echo "Changed mission files:"
          echo "$CHANGED_MISSIONS"

          cat << 'EOF' > codex_prompt.txt
          You are an autonomous senior software engineer.

          The markdown files under .agent/missions/ are authoritative mission specifications.
          Apply the updated mission specs to the codebase.

          Rules:
          - Only change code required to satisfy the missions.
          - Do not change unrelated code.
          - Do not modify the mission markdown files.
          - If you cannot safely implement something, explain in a comment in the PR instead of guessing.
          EOF

          # 예시: codex cli가 설치되어 있다고 가정
          codex exec \
            --prompt-file codex_prompt.txt \
            --context "$CHANGED_MISSIONS"

      - name: Commit and push changes to PR branch
        run: |
          if git status --porcelain | grep .; then
            git config user.name "codex-bot"
            git config user.email "codex-bot@users.noreply.github.com"
            git add .
            git commit -m "chore: apply mission spec via Codex"
            git push
          else
            echo "No code changes produced by Codex."
          fi
